<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Heatmaps</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100%;
        }

        #time-line {
            padding: 3px 5px;
            background-color : #fff;
            border : 2px solid #fff;
            border-radius : 3px;
            box-shadow : 0 2px 6px rgba(0,0,0,.3);
            cursor : pointer;
            width: 30%;
            text-align: center;
            z-index: 1;
        }
        #time-line input{
            width: 100%;
        }

        #product-line{
            padding: 3px 5px;
            background-color : #fff;
            border : 2px solid #fff;
            border-radius : 3px;
            box-shadow : 0 2px 6px rgba(0,0,0,.3);
            cursor : pointer;
            width: 135px;
            z-index: 1;
        }
    </style>
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
</head>

<body>
<div id="time-line">
    <span id="month">Month: 1</span>
    <input type="range" id="timeCtrl" min="1" max="12" step="1" value="0"/>
</div>
<div id="product-line">
    <label>Product: </label>
    <select id="productCtrl">
        <option value="Office">Office</option>
        <option value="Windows">Windows</option>
    </select>
</div>
<div id="map"></div>
<script>

    var map, heatmap;
    var allData, zuora;
    var currentProduct = "Office", currentMonth = 1;

    function initMap() {
        var sanFrancisco = new google.maps.LatLng(37.774546, -122.433523);
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 13,
            center: sanFrancisco,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            streetViewControl: false,
            mapTypeControl: false
        });

        map.controls[google.maps.ControlPosition.TOP_CENTER].push(document.getElementById("time-line"));
        map.controls[google.maps.ControlPosition.LEFT_CENTER].push(document.getElementById("product-line"));

        heatmap = new google.maps.visualization.HeatmapLayer({
            map: map
        });

        $.getJSON("testdata/sf.json", function(data){
            allData = data;
            updateMapData();
        });

        zuora = [
            {location: new google.maps.LatLng(47, -114), weight:200},
            {location: new google.maps.LatLng(47, -113), weight:200},
            {location: new google.maps.LatLng(47, -112), weight:200},
            {location: new google.maps.LatLng(47, -111), weight:200},
            {location: new google.maps.LatLng(47, -110), weight:200},
            {location: new google.maps.LatLng(47, -109), weight:200},
            {location: new google.maps.LatLng(47, -108), weight:200},
            {location: new google.maps.LatLng(47, -107), weight:200},
            {location: new google.maps.LatLng(47, -106), weight:200},
            {location: new google.maps.LatLng(47, -105), weight:200},
            {location: new google.maps.LatLng(47, -104), weight:200},
            {location: new google.maps.LatLng(47, -103), weight:200},
            {location: new google.maps.LatLng(47, -102), weight:200},
            {location: new google.maps.LatLng(47, -101), weight:200},
            {location: new google.maps.LatLng(47, -100), weight:200},
            {location: new google.maps.LatLng(47, -99), weight:200},
            {location: new google.maps.LatLng(47, -98), weight:200},
            {location: new google.maps.LatLng(46, -99), weight:200},
            {location: new google.maps.LatLng(45.5, -100), weight:200},
            {location: new google.maps.LatLng(45, -101), weight:200},
            {location: new google.maps.LatLng(44, -102), weight:200},
            {location: new google.maps.LatLng(43.5, -103), weight:200},
            {location: new google.maps.LatLng(43, -104), weight:200},
            {location: new google.maps.LatLng(42, -105), weight:200},
            {location: new google.maps.LatLng(41.5, -106), weight:200},
            {location: new google.maps.LatLng(41, -107), weight:200},
            {location: new google.maps.LatLng(40, -108), weight:200},
            {location: new google.maps.LatLng(39.5, -109), weight:200},
            {location: new google.maps.LatLng(39, -110), weight:200},
            {location: new google.maps.LatLng(38, -111), weight:200},
            {location: new google.maps.LatLng(37.5, -112), weight:200},
            {location: new google.maps.LatLng(36, -113), weight:200},
            {location: new google.maps.LatLng(35, -114), weight:200},
            {location: new google.maps.LatLng(35, -113), weight:200},
            {location: new google.maps.LatLng(35, -112), weight:200},
            {location: new google.maps.LatLng(35, -111), weight:200},
            {location: new google.maps.LatLng(35, -110), weight:200},
            {location: new google.maps.LatLng(35, -109), weight:200},
            {location: new google.maps.LatLng(35, -108), weight:200},
            {location: new google.maps.LatLng(35, -107), weight:200},
            {location: new google.maps.LatLng(35, -106), weight:200},
            {location: new google.maps.LatLng(35, -105), weight:200},
            {location: new google.maps.LatLng(35, -104), weight:200},
            {location: new google.maps.LatLng(35, -103), weight:200},
            {location: new google.maps.LatLng(35, -102), weight:200},
            {location: new google.maps.LatLng(35, -101), weight:200},
            {location: new google.maps.LatLng(35, -100), weight:200},
            {location: new google.maps.LatLng(35, -99), weight:200},
            {location: new google.maps.LatLng(35, -98), weight:200}
        ]
    }

    function updateMapData(){
        if( currentMonth == 12 ){
            heatmap.setData(zuora);
            return ;
        }
        var mapData = allData.map(function(p){
            var loc = new google.maps.LatLng(p.coordinate.lat, p.coordinate.lng);
            var weight = p.products.filter(function(prod){
                return prod.name == currentProduct;
            })[0]["amounts"][currentMonth - 1];
                return {
                    location : loc,
                    weight : weight
                }
            });

        heatmap.setData(mapData);
    }

    $(document).ready(function(){
        $("#productCtrl").change(function(){
            currentProduct = $(this).val();
            updateMapData();
        })
        $("#timeCtrl").change(function(){
            currentMonth = parseInt($(this).val());
            $("#month").html("Month: " + currentMonth);
            updateMapData();
        })
    })


</script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA60KhSNulq-LhqKxvtQTlNTiilyythzL8&signed_in=true&libraries=visualization&callback=initMap">
</script>
</body>
</html>
